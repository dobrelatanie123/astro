---
import Layout from "../layouts/Layout.astro";

const { user } = Astro.locals;

// Redirect if already logged in
if (user) {
  return Astro.redirect('/claims');
}

const errorMessage = Astro.url.searchParams.get('error');
---

<Layout title="Sign Up | Lumos">
  <div class="min-h-screen bg-slate-950 flex items-center justify-center px-4">
    <div class="w-full max-w-md">
      <!-- Logo -->
      <div class="text-center mb-8">
        <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-violet-500 to-fuchsia-500 flex items-center justify-center mx-auto mb-4 shadow-lg shadow-violet-500/25">
          <span class="text-3xl">üîç</span>
        </div>
        <h1 class="text-3xl font-bold bg-gradient-to-r from-violet-400 to-fuchsia-400 bg-clip-text text-transparent">
          Join Lumos
        </h1>
        <p class="text-slate-500 mt-2">Create an account to save verified claims</p>
      </div>

      <!-- Error Message -->
      {errorMessage && (
        <div class="mb-6 p-4 rounded-xl bg-red-500/10 border border-red-500/30 text-red-400 text-sm">
          {errorMessage}
        </div>
      )}

      <!-- Signup Form -->
      <div class="bg-slate-900/50 rounded-2xl p-8 border border-slate-800">
        <form id="signup-form" class="space-y-6">
          <div>
            <label for="email" class="block text-sm font-medium text-slate-300 mb-2">
              Email
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full px-4 py-3 rounded-xl bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-500 focus:outline-none focus:border-violet-500 focus:ring-1 focus:ring-violet-500 transition-colors"
              placeholder="you@example.com"
            />
          </div>

          <div>
            <label for="password" class="block text-sm font-medium text-slate-300 mb-2">
              Password
            </label>
            <input
              type="password"
              id="password"
              name="password"
              required
              minlength="6"
              class="w-full px-4 py-3 rounded-xl bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-500 focus:outline-none focus:border-violet-500 focus:ring-1 focus:ring-violet-500 transition-colors"
              placeholder="At least 6 characters"
            />
          </div>

          <div>
            <label for="confirm-password" class="block text-sm font-medium text-slate-300 mb-2">
              Confirm Password
            </label>
            <input
              type="password"
              id="confirm-password"
              name="confirm-password"
              required
              minlength="6"
              class="w-full px-4 py-3 rounded-xl bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-500 focus:outline-none focus:border-violet-500 focus:ring-1 focus:ring-violet-500 transition-colors"
              placeholder="Confirm your password"
            />
          </div>

          <button
            type="submit"
            class="w-full py-3 px-4 rounded-xl bg-gradient-to-r from-violet-600 to-fuchsia-600 hover:from-violet-500 hover:to-fuchsia-500 text-white font-medium transition-all shadow-lg shadow-violet-500/25"
          >
            Create Account
          </button>
        </form>

        <div class="mt-6 text-center">
          <p class="text-slate-500 text-sm">
            Already have an account? 
            <a href="/login" class="text-violet-400 hover:text-violet-300 transition-colors">
              Sign in
            </a>
          </p>
        </div>
      </div>

      <!-- Terms -->
      <p class="mt-6 text-center text-xs text-slate-600">
        By signing up, you agree to our terms of service and privacy policy.
      </p>
    </div>
  </div>
</Layout>

<script>
  import { createClient } from '@supabase/supabase-js';
  
  const supabase = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL || 'https://zehilcqtaedymmwlndpm.supabase.co',
    import.meta.env.PUBLIC_SUPABASE_KEY || 'sb_publishable_L2HgCiCIPHjz3mKZ4-ABGQ_PtJiuzUz'
  );

  document.getElementById('signup-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target as HTMLFormElement;
    const email = (form.querySelector('#email') as HTMLInputElement).value;
    const password = (form.querySelector('#password') as HTMLInputElement).value;
    const confirmPassword = (form.querySelector('#confirm-password') as HTMLInputElement).value;
    
    if (password !== confirmPassword) {
      window.location.href = `/signup?error=${encodeURIComponent('Passwords do not match')}`;
      return;
    }
    
    const { error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        emailRedirectTo: `${window.location.origin}/auth/callback`,
      },
    });
    
    if (error) {
      window.location.href = `/signup?error=${encodeURIComponent(error.message)}`;
    } else {
      window.location.href = `/login?message=${encodeURIComponent('Check your email to confirm your account!')}`;
    }
  });
</script>

